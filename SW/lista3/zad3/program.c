#include <avr/io.h>
#include <avr/pgmspace.h>
#include <avr/sfr_defs.h>
#include <stdint.h>
#include <util/delay.h>

#define LED PB1
#define LED_DDR DDRB
#define LED_PORT PORTB

static const uint16_t exp_table[] PROGMEM = {
    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,   0,   0,
    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,   0,   0,
    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,   0,   0,
    0,    0,    0,    0,    0,    1,    1,    1,    1,    1,    1,   1,   1,
    1,    1,    1,    1,    1,    1,    1,    1,    1,    2,    2,   2,   2,
    2,    2,    2,    2,    2,    2,    2,    2,    3,    3,    3,   3,   3,
    3,    3,    3,    3,    3,    4,    4,    4,    4,    4,    4,   4,   4,
    4,    5,    5,    5,    5,    5,    5,    5,    5,    6,    6,   6,   6,
    6,    6,    6,    7,    7,    7,    7,    7,    7,    8,    8,   8,   8,
    8,    8,    8,    9,    9,    9,    9,    9,    10,   10,   10,  10,  10,
    10,   11,   11,   11,   11,   11,   12,   12,   12,   12,   12,  13,  13,
    13,   13,   13,   14,   14,   14,   14,   14,   15,   15,   15,  15,  16,
    16,   16,   16,   17,   17,   17,   17,   17,   18,   18,   18,  18,  19,
    19,   19,   19,   20,   20,   20,   21,   21,   21,   21,   22,  22,  22,
    22,   23,   23,   23,   24,   24,   24,   24,   25,   25,   25,  26,  26,
    26,   26,   27,   27,   27,   28,   28,   28,   29,   29,   29,  30,  30,
    30,   31,   31,   31,   32,   32,   32,   33,   33,   33,   34,  34,  34,
    35,   35,   35,   36,   36,   36,   37,   37,   37,   38,   38,  39,  39,
    39,   40,   40,   40,   41,   41,   42,   42,   42,   43,   43,  44,  44,
    44,   45,   45,   46,   46,   46,   47,   47,   48,   48,   48,  49,  49,
    50,   50,   51,   51,   51,   52,   52,   53,   53,   54,   54,  54,  55,
    55,   56,   56,   57,   57,   58,   58,   59,   59,   60,   60,  60,  61,
    61,   62,   62,   63,   63,   64,   64,   65,   65,   66,   66,  67,  67,
    68,   68,   69,   69,   70,   70,   71,   71,   72,   72,   73,  73,  74,
    74,   75,   76,   76,   77,   77,   78,   78,   79,   79,   80,  80,  81,
    81,   82,   83,   83,   84,   84,   85,   85,   86,   87,   87,  88,  88,
    89,   89,   90,   91,   91,   92,   92,   93,   94,   94,   95,  95,  96,
    97,   97,   98,   98,   99,   100,  100,  101,  102,  102,  103, 103, 104,
    105,  105,  106,  107,  107,  108,  109,  109,  110,  111,  111, 112, 112,
    113,  114,  114,  115,  116,  116,  117,  118,  119,  119,  120, 121, 121,
    122,  123,  123,  124,  125,  125,  126,  127,  128,  128,  129, 130, 130,
    131,  132,  133,  133,  134,  135,  135,  136,  137,  138,  138, 139, 140,
    141,  141,  142,  143,  144,  144,  145,  146,  147,  147,  148, 149, 150,
    151,  151,  152,  153,  154,  154,  155,  156,  157,  158,  158, 159, 160,
    161,  162,  162,  163,  164,  165,  166,  166,  167,  168,  169, 170, 171,
    171,  172,  173,  174,  175,  176,  176,  177,  178,  179,  180, 181, 182,
    182,  183,  184,  185,  186,  187,  188,  188,  189,  190,  191, 192, 193,
    194,  195,  196,  196,  197,  198,  199,  200,  201,  202,  203, 204, 205,
    205,  206,  207,  208,  209,  210,  211,  212,  213,  214,  215, 216, 217,
    218,  219,  219,  220,  221,  222,  223,  224,  225,  226,  227, 228, 229,
    230,  231,  232,  233,  234,  235,  236,  237,  238,  239,  240, 241, 242,
    243,  244,  245,  246,  247,  248,  249,  250,  251,  252,  253, 254, 255,
    256,  257,  258,  259,  260,  261,  262,  264,  265,  266,  267, 268, 269,
    270,  271,  272,  273,  274,  275,  276,  277,  278,  280,  281, 282, 283,
    284,  285,  286,  287,  288,  289,  290,  292,  293,  294,  295, 296, 297,
    298,  299,  301,  302,  303,  304,  305,  306,  307,  309,  310, 311, 312,
    313,  314,  315,  317,  318,  319,  320,  321,  322,  324,  325, 326, 327,
    328,  329,  331,  332,  333,  334,  335,  337,  338,  339,  340, 341, 343,
    344,  345,  346,  348,  349,  350,  351,  352,  354,  355,  356, 357, 359,
    360,  361,  362,  364,  365,  366,  367,  369,  370,  371,  372, 374, 375,
    376,  378,  379,  380,  381,  383,  384,  385,  387,  388,  389, 390, 392,
    393,  394,  396,  397,  398,  400,  401,  402,  404,  405,  406, 408, 409,
    410,  412,  413,  414,  416,  417,  418,  420,  421,  422,  424, 425, 426,
    428,  429,  431,  432,  433,  435,  436,  437,  439,  440,  442, 443, 444,
    446,  447,  449,  450,  451,  453,  454,  456,  457,  458,  460, 461, 463,
    464,  466,  467,  468,  470,  471,  473,  474,  476,  477,  479, 480, 481,
    483,  484,  486,  487,  489,  490,  492,  493,  495,  496,  498, 499, 501,
    502,  504,  505,  507,  508,  510,  511,  513,  514,  516,  517, 519, 520,
    522,  523,  525,  526,  528,  529,  531,  532,  534,  536,  537, 539, 540,
    542,  543,  545,  546,  548,  550,  551,  553,  554,  556,  557, 559, 561,
    562,  564,  565,  567,  569,  570,  572,  573,  575,  577,  578, 580, 581,
    583,  585,  586,  588,  589,  591,  593,  594,  596,  598,  599, 601, 603,
    604,  606,  608,  609,  611,  613,  614,  616,  618,  619,  621, 623, 624,
    626,  628,  629,  631,  633,  634,  636,  638,  639,  641,  643, 645, 646,
    648,  650,  651,  653,  655,  657,  658,  660,  662,  664,  665, 667, 669,
    671,  672,  674,  676,  678,  679,  681,  683,  685,  686,  688, 690, 692,
    693,  695,  697,  699,  701,  702,  704,  706,  708,  710,  711, 713, 715,
    717,  719,  720,  722,  724,  726,  728,  730,  731,  733,  735, 737, 739,
    741,  742,  744,  746,  748,  750,  752,  753,  755,  757,  759, 761, 763,
    765,  767,  768,  770,  772,  774,  776,  778,  780,  782,  784, 786, 787,
    789,  791,  793,  795,  797,  799,  801,  803,  805,  807,  809, 810, 812,
    814,  816,  818,  820,  822,  824,  826,  828,  830,  832,  834, 836, 838,
    840,  842,  844,  846,  848,  850,  852,  854,  856,  858,  860, 862, 864,
    866,  868,  870,  872,  874,  876,  878,  880,  882,  884,  886, 888, 890,
    892,  894,  896,  898,  900,  902,  904,  906,  908,  911,  913, 915, 917,
    919,  921,  923,  925,  927,  929,  931,  933,  935,  938,  940, 942, 944,
    946,  948,  950,  952,  954,  957,  959,  961,  963,  965,  967, 969, 971,
    974,  976,  978,  980,  982,  984,  986,  989,  991,  993,  995, 997, 999,
    1002, 1004, 1006, 1008, 1010, 1013, 1015, 1017, 1019, 1021,
};

void pwm(uint16_t fill) {
  if (fill == 0) {
    TCCR1A = 0;
    TCCR1B = 0;
    return;
  }

  /*
   * WGM12:0 = 5 -> Fast PWM 10-bit
   * COM1A1 = 1 -> set on Compare Match
   */
  TCCR1A = _BV(COM1A1) | _BV(WGM11) | _BV(WGM10);

  /*
   * Prescaler = 1
   */
  TCCR1B = _BV(WGM12) | _BV(CS10);

  OCR1A = fill;
}

void adc_init() {
  ADMUX = _BV(REFS0); // referencja AVcc
  // multiplekser na ADC0
  ADMUX &= ~(_BV(MUX0) | _BV(MUX1) | _BV(MUX2) | _BV(MUX3));
  DIDR0 = _BV(ADC0D); // wyłącz wejście cyfrowe na ADC0
  // częstotliwość zegara ADC 125 kHz (16 MHz / 128)
  // ADCSRA = _BV(ADPS0) | _BV(ADPS1) | _BV(ADPS2); // preskaler 128
  ADCSRA |= _BV(ADEN); // włącz ADC
}

uint16_t adc_measure() {
  ADCSRA |= _BV(ADSC); // wykonaj konwersję
  while (!(ADCSRA & _BV(ADIF)))
    ;                  // czekaj na wynik
  ADCSRA |= _BV(ADIF); // wyczyść bit ADIF (pisząc 1!)
  return ADC;          // weź zmierzoną wartość (0..1023)
}

int main(void) {
  LED_DDR |= _BV(LED);

  adc_init();

  uint16_t val = 0;
  while (1) {
    pwm(0);
    val = adc_measure(); // 0 - 16
    pwm(pgm_read_u16(&exp_table[val]));
    _delay_ms(50);
  }
}
